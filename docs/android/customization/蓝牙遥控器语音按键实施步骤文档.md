# è“ç‰™é¥æ§å™¨è¯­éŸ³æŒ‰é”®å®æ–½æ­¥éª¤æ–‡æ¡£

## æ–‡æ¡£ç‰ˆæœ¬ä¿¡æ¯

- **ç‰ˆæœ¬**ï¼šv3.0ï¼ˆå®é™…æ‰§è¡Œç‰ˆæœ¬ï¼ŒåŠŸèƒ½æµ‹è¯•é€šè¿‡ï¼‰
- **åˆ›å»ºæ—¶é—´**ï¼š2025-11-12
- **æœ€åæ›´æ–°**ï¼š2025-11-13
- **çŠ¶æ€**ï¼šâœ… æ‰€æœ‰åŠŸèƒ½å·²æµ‹è¯•é€šè¿‡
- **äº§å“**ï¼šross / Android 14 / Amlogic S905X5

---

## ä¸€ã€é¡¹ç›®èƒŒæ™¯

### 1.1 ä¾›åº”å•†æä¾›çš„ Patch ç›®å½•ç»“æ„

```
bt-remote-patch/
â”œâ”€â”€ android14/                                   # Android 14 ä¸“ç”¨æ–‡ä»¶
â”‚   â”œâ”€â”€ audio.blehid.default.so                  # HBG Audio HAL å®ç°ï¼ˆ32-bit ARM, 22KBï¼‰
â”‚   â”œâ”€â”€ blehid_audio_policy_configuration.xml    # BLEHID éŸ³é¢‘ç­–ç•¥é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ hidraw.png                               # hidraw è®¾å¤‡è¯´æ˜å›¾ç‰‡
â”‚   â””â”€â”€ é™„åŠ æ–¹æ¡ˆ.patch                            # ç³»ç»Ÿæ¡†æ¶å±‚ä¿®æ”¹ patchï¼ˆç¼–ç æ˜¯ GB 2312ï¼‰
â”œâ”€â”€ libhbgdecode.so                              # HBG éŸ³é¢‘è§£ç åº“ï¼ˆ32-bit ARM, 46KBï¼‰
â”œâ”€â”€ é›†æˆpatchåè°ƒè¯•æ­¥éª¤.txt                        # éƒ¨ç½²å’Œæµ‹è¯•è¯´æ˜æ–‡æ¡£ï¼ˆç¼–ç æ˜¯ GB 2312ï¼‰
â”œâ”€â”€ RecordTool.apk                               # å½•éŸ³æµ‹è¯•å·¥å…·ï¼ˆ1.5MBï¼‰
â””â”€â”€ remote.txt                                   # é¥æ§å™¨é…ç½®æ¨¡æ¿ï¼ˆVID/PIDç­‰å‚æ•°ï¼‰

ç›®å½•è¯´æ˜ï¼š
- android14/: Android 14 ä¸“ç”¨é…ç½®å’Œåº“æ–‡ä»¶
- libhbgdecode.so: ä¸ Android ç‰ˆæœ¬æ— å…³çš„è§£ç åº“
- RecordTool.apk: ç”¨äºæµ‹è¯•é¥æ§å™¨è¯­éŸ³å½•éŸ³åŠŸèƒ½
- remote.txt: é…ç½®æ¨¡æ¿ï¼ˆéœ€æ ¹æ®å®é™…é¥æ§å™¨ä¿®æ”¹ VID/PIDï¼‰
```

---

### 1.2 ç›®æ ‡
å°†é¥æ§å™¨ä¾›åº”å•†æä¾›çš„ Android 14 è“ç‰™é¥æ§å™¨è¯­éŸ³æŒ‰é”® patch é€‚é…åˆ°å½“å‰é¡¹ç›®ï¼ˆross/Android 14ï¼‰

### 1.3 æ ¸å¿ƒåŠŸèƒ½
æ·»åŠ  `AUDIO_DEVICE_IN_BLEHID` éŸ³é¢‘è¾“å…¥è®¾å¤‡ï¼Œå®ç°ï¼š
- å½“é¥æ§å™¨æŒ‰ä¸‹è¯­éŸ³é”®æ—¶ï¼Œç³»ç»Ÿè‡ªåŠ¨å°†éŸ³é¢‘è¾“å…¥ä» Built-in Mic åˆ‡æ¢åˆ°é¥æ§å™¨éº¦å…‹é£
- é€šè¿‡æ£€æµ‹ `/data/vendor/HBG/ble` æ–‡ä»¶çš„å­˜åœ¨æ¥åˆ¤æ–­é¥æ§å™¨è¯­éŸ³é”®çŠ¶æ€
- éŸ³é¢‘å‚æ•°ï¼š16kHz / PCM_16_BIT / MONO

### 1.4 ç”¨æˆ·ç¡®è®¤ä¿¡æ¯

| é¡¹ç›® | ç¡®è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| äº§å“åç§° | ross | âœ“ |
| åº“æ–‡ä»¶è·¯å¾„ | vendor/giec/executable/hbg/ | æ–°å»ºç›®å½•ï¼Œä½¿ç”¨ Android.mk |
| éŸ³é¢‘é…ç½®æ–‡ä»¶ | device/amlogic/common/audio/audio_policy_configuration_temp.xml | âœ“ |
| Audio Policy ç‰ˆæœ¬ | V7.0 | audioPolicyConfiguration version |
| **Audio HAL ç‰ˆæœ¬** | **7.1** | **å®é™…ä½¿ç”¨ç‰ˆæœ¬ï¼ˆmanifest ç¡®è®¤ï¼‰** |
| ç³»ç»Ÿæ¶æ„ | arm (32-bit) | âœ“ |
| é¥æ§å™¨ VID/PID | vendor=0x000d, product=0x3838 | æ ¹æ® dumpsys input ä¿®æ”¹ |
| init.rc æ–‡ä»¶ | device/amlogic/common/products/mbox/init.amlogic.system.rc | ç›´æ¥ä¿®æ”¹ |

---

## äºŒã€æŠ€æœ¯æ–¹æ¡ˆæ¦‚è¿°

### 2.1 æ ¸å¿ƒè®¾è®¡

æ·»åŠ æ–°çš„éŸ³é¢‘è¾“å…¥è®¾å¤‡ç±»å‹ `AUDIO_DEVICE_IN_BLEHID`ï¼ˆå€¼ï¼š0x80200000ï¼‰ï¼Œä¸“é—¨ç”¨äºè“ç‰™é¥æ§å™¨è¯­éŸ³è¾“å…¥ã€‚

**è®¾å¤‡åˆ‡æ¢è§¦å‘æ¡ä»¶ï¼š**
```c
if (AUDIO_DEVICE_IN_BUILTIN_MIC == device->type() &&
    access("/data/vendor/HBG/ble", F_OK) == 0 &&
    config->sample_rate == 16000 &&
    config->format == 0x1 &&
    config->channel_mask == 0x10)
```

**å…³é”®è®¾è®¡å‚æ•°ï¼š**
- **è®¾å¤‡ç±»å‹å€¼**ï¼š`0x200000u` (åŸºç¡€å€¼) + `0x80000000u` (IN_BIT) = `0x80200000`
- **è§¦å‘æ–‡ä»¶**ï¼š`/data/vendor/HBG/ble`
- **éŸ³é¢‘å‚æ•°**ï¼š16000Hz / AUDIO_FORMAT_PCM_16_BIT / AUDIO_CHANNEL_IN_MONO

### 2.2 æ¶æ„å›¾

```
åº”ç”¨å±‚ï¼ˆå½•éŸ³ APPï¼‰
    â†“
AudioPolicyManager (frameworks/av)
    â”œâ”€ æ£€æµ‹ /data/vendor/HBG/ble æ–‡ä»¶
    â””â”€ åˆ‡æ¢è®¾å¤‡ï¼šBUILTIN_MIC â†’ BLEHID
    â†“
Audio HAL 7.1 (hardware/interfaces)
    â”œâ”€ HIDL æ¥å£æ”¯æŒ
    â””â”€ StreamIn ç‰¹æ®Šå¤„ç†
    â†“
HAL å®ç° (vendor/giec/executable/hbg)
    â”œâ”€ audio.blehid.default.so
    â””â”€ libhbgdecode.so
```

---

## ä¸‰ã€å®é™…æ‰§è¡Œçš„è¯¦ç»†æ­¥éª¤

### âš ï¸ ä¸ Patch çš„å·®å¼‚è¯´æ˜

| å·®å¼‚é¡¹ | Patch åŸæ–¹æ¡ˆ | å®é™…æ‰§è¡Œæ–¹æ¡ˆ | åŸå›  |
|--------|-------------|-------------|------|
| **åº“æ–‡ä»¶è·¯å¾„** | device/amlogic/common/prebuilt/audio/ | vendor/giec/executable/hbg/ | 1. åŸè·¯å¾„ä¸å­˜åœ¨<br>2. å¤ç”¨ç°æœ‰ vendor/giec ç»“æ„<br>3. å‚è€ƒ MPTools æ¨¡å¼ |
| **é¥æ§å™¨ VID/PID** | vendor=0x1d5a, product=0xc081 | vendor=0x000d, product=0x3838 | æ ¹æ®å®é™…è®¾å¤‡ dumpsys input æ•°æ®ä¿®æ”¹ |
| **init.rc ä½ç½®** | æ–°å»º init.hbg.remote.rc | ç›´æ¥ä¿®æ”¹ init.amlogic.system.rc | ç®€åŒ–é›†æˆï¼Œé¿å…é¢å¤–æ–‡ä»¶ |
| **Audio HAL 7.1** | Patch åŒ…å« 7.1 ä¿®æ”¹ | é€šè¿‡ manifest ç¡®è®¤å®é™…ä½¿ç”¨ 7.1 |
| **éŸ³é¢‘é…ç½®æ–‡ä»¶** | frameworks/av/.../audio_policy_configuration.xml | device/amlogic/.../audio_policy_configuration_temp.xml | Amlogic å¹³å°ä½¿ç”¨å®šåˆ¶é…ç½® |

---

### é˜¶æ®µ 0ï¼šå‡†å¤‡å·¥ä½œ

#### æ­¥éª¤ 0.1ï¼šåˆ›å»ºç›®å½•å¹¶å¤åˆ¶åº“æ–‡ä»¶

**æ‰§è¡Œå‘½ä»¤ï¼š**
```bash
mkdir -p vendor/giec/executable/hbg
cp bt-remote-patch/android14/audio.blehid.default.so vendor/giec/executable/hbg/
cp bt-remote-patch/libhbgdecode.so vendor/giec/executable/hbg/
```

**æ–‡ä»¶æ¸…å•ï¼š**
- `vendor/giec/executable/hbg/audio.blehid.default.so` (22064 bytes, ELF 32-bit ARM)
- `vendor/giec/executable/hbg/libhbgdecode.so` (46524 bytes, ELF 32-bit ARM)

âœ… **å®Œæˆ**

---

#### æ­¥éª¤ 0.2ï¼šåˆ›å»º remote.txt é…ç½®æ–‡ä»¶

**æ–‡ä»¶ï¼š** `vendor/giec/executable/hbg/remote.txt`

**å†…å®¹ï¼š**
```
VENDOR_ID:0x000d
PRODUCT_ID:0x3838
AUDIOKEY_REPORTID:0x03
AUDIOKEY_VALUE:0x221
DYNAMIC_BLE:1
START_RADIO:
STOP_RADIO:
DEBUG_LOG:4
FORMAT_AU:1
MIC_KEY_TYPE:0
SAMPLE_TYPE:0
CMD_REPORTID:0x01
```

âš ï¸ **ä¸ Patch å·®å¼‚ï¼š**
- Patch åŸå€¼ï¼š`VENDOR_ID:0x1d5a, PRODUCT_ID:0xc081`
- å®é™…ä½¿ç”¨ï¼š`VENDOR_ID:0x000d, PRODUCT_ID:0x3838`
- **åŸå› **ï¼šæ ¹æ® `dumpsys input` å®é™…é¥æ§å™¨è®¾å¤‡ä¿¡æ¯ä¿®æ”¹

âœ… **å®Œæˆ**

---

#### æ­¥éª¤ 0.3ï¼šåˆ›å»º Android.mk ç¼–è¯‘é…ç½®

**æ–‡ä»¶ï¼š** `vendor/giec/executable/hbg/Android.mk`

**å†…å®¹ï¼š**
```makefile
LOCAL_PATH := $(call my-dir)

# Deploy HBG BLE Remote Audio HAL
##########################################

# 1. Install audio.blehid.default.so to /vendor/lib/hw
include $(CLEAR_VARS)
LOCAL_MODULE := audio.blehid.default
LOCAL_SRC_FILES := audio.blehid.default.so
LOCAL_MODULE_SUFFIX := .so
LOCAL_MODULE_CLASS := SHARED_LIBRARIES
LOCAL_MODULE_TAGS := optional
LOCAL_MODULE_PATH := $(TARGET_OUT_VENDOR)/lib/hw
LOCAL_MODULE_OWNER := vendor
LOCAL_PROPRIETARY_MODULE := true
LOCAL_CHECK_ELF_FILES := false
include $(BUILD_PREBUILT)

# 2. Install libhbgdecode.so to /vendor/lib
include $(CLEAR_VARS)
LOCAL_MODULE := libhbgdecode
LOCAL_SRC_FILES := libhbgdecode.so
LOCAL_MODULE_SUFFIX := .so
LOCAL_MODULE_CLASS := SHARED_LIBRARIES
LOCAL_MODULE_TAGS := optional
LOCAL_MODULE_PATH := $(TARGET_OUT_VENDOR)/lib
LOCAL_MODULE_OWNER := vendor
LOCAL_PROPRIETARY_MODULE := true
LOCAL_CHECK_ELF_FILES := false
include $(BUILD_PREBUILT)

# 3. Install remote.txt to /vendor/etc
include $(CLEAR_VARS)
LOCAL_MODULE := hbg_remote_config
LOCAL_SRC_FILES := remote.txt
LOCAL_MODULE_CLASS := ETC
LOCAL_MODULE_TAGS := optional
LOCAL_MODULE_PATH := $(TARGET_OUT_VENDOR)/etc
LOCAL_MODULE_OWNER := vendor
LOCAL_MODULE_STEM := remote.txt
include $(BUILD_PREBUILT)
```

**è¯´æ˜ï¼š**
- è‡ªåŠ¨è¢« `vendor/giec/executable/Android.mk` åŒ…å«ï¼ˆä½¿ç”¨ `include $(all-subdir-makefiles)`ï¼‰
- å‚è€ƒ `vendor/giec/executable/MPTools/Android.mk` çš„ç»“æ„

âœ… **å®Œæˆ**

---

#### æ­¥éª¤ 0.4ï¼šå¤åˆ¶éŸ³é¢‘ç­–ç•¥é…ç½®æ–‡ä»¶

**æ–‡ä»¶ï¼š** `device/amlogic/common/audio/blehid_audio_policy_configuration.xml`

**æ¥æºï¼š** `bt-remote-patch/android14/blehid_audio_policy_configuration.xml`

**å†…å®¹ï¼š**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!-- Blehid Audio HAL Audio Policy Configuration file -->

<module name="blehid" halVersion="2.0">
    <attachedDevices>
        <item>hbg_audio</item>
    </attachedDevices>
    <mixPorts>
        <mixPort name="blehid input" role="sink">
            <profile name="" format="AUDIO_FORMAT_PCM_16_BIT" channelMasks="AUDIO_CHANNEL_IN_MONO" samplingRates="16000"/>
        </mixPort>
    </mixPorts>
    <devicePorts>
        <devicePort tagName="hbg_audio" type="AUDIO_DEVICE_IN_BLEHID" role="source">
            <profile name="" format="AUDIO_FORMAT_PCM_16_BIT" channelMasks="AUDIO_CHANNEL_IN_MONO" samplingRates="16000"/>
        </devicePort>
    </devicePorts>
    <routes>
        <route type="mix" sink="blehid input" sources="hbg_audio"/>
    </routes>
</module>
```

âœ… **å®Œæˆ**

---

### é˜¶æ®µ 1ï¼šç³»ç»Ÿæ¡†æ¶å±‚ä¿®æ”¹

#### æ­¥éª¤ 1.1ï¼šå®šä¹‰ AUDIO_DEVICE_IN_BLEHID è®¾å¤‡ç±»å‹

**æ–‡ä»¶ 1ï¼š** `system/media/audio/include/system/audio-hal-enums.h`

**ä¿®æ”¹ä½ç½®ï¼š** ç¬¬ 395 è¡Œ

**ä¿®æ”¹å†…å®¹ï¼š**
```c
V(AUDIO_DEVICE_IN_LOOPBACK, AUDIO_DEVICE_BIT_IN | 0x40000u) \
V(AUDIO_DEVICE_IN_IP, AUDIO_DEVICE_BIT_IN | 0x80000u) \
V(AUDIO_DEVICE_IN_BUS, AUDIO_DEVICE_BIT_IN | 0x100000u) \
V(AUDIO_DEVICE_IN_BLEHID, AUDIO_DEVICE_BIT_IN | 0x200000u) \    // â† æ–°å¢
V(AUDIO_DEVICE_IN_PROXY, AUDIO_DEVICE_BIT_IN | 0x1000000u) \
```

**å…³é”®è¯´æ˜ï¼š**
- **è®¾å¤‡å€¼**ï¼š`0x80200000` = `0x80000000` (AUDIO_DEVICE_BIT_IN) | `0x200000u`
- **å€¼å†²çªæ£€æŸ¥**ï¼šç¬¬ 362 è¡Œå­˜åœ¨ `AUDIO_DEVICE_OUT_AUX_LINE = 0x200000u`
  - âœ… **æ— å†²çª**ï¼šè¾“å‡ºè®¾å¤‡ï¼ˆ0x00200000ï¼‰vs è¾“å…¥è®¾å¤‡ï¼ˆ0x80200000ï¼‰
  - é€šè¿‡æœ€é«˜ä½åŒºåˆ†ï¼šOUT=0x0xxxxxxx, IN=0x8xxxxxxx

âœ… **å®Œæˆ**

---

**æ–‡ä»¶ 2ï¼š** `system/media/audio/include/system/audio-base-utils.h`

**ä¿®æ”¹ä½ç½® Aï¼š** ç¬¬ 120 è¡Œï¼ˆAUDIO_DEVICE_IN_ALL_SETï¼‰

```c
                            AUDIO_DEVICE_IN_LOOPBACK |
                            AUDIO_DEVICE_IN_IP |
                            AUDIO_DEVICE_IN_BUS |
                            AUDIO_DEVICE_IN_BLEHID |        // â† æ–°å¢
                            AUDIO_DEVICE_IN_PROXY |
```

**ä¿®æ”¹ä½ç½® Bï¼š** ç¬¬ 266 è¡Œï¼ˆAUDIO_DEVICE_IN_ALL_ARRAYï¼‰

```c
AUDIO_DEVICE_IN_LOOPBACK,                   // 0x80040000u
AUDIO_DEVICE_IN_IP,                         // 0x80080000u
AUDIO_DEVICE_IN_BUS,                        // 0x80100000u
AUDIO_DEVICE_IN_BLEHID,                     // 0x80200000u    // â† æ–°å¢
AUDIO_DEVICE_IN_PROXY,                      // 0x81000000u
```

âœ… **å®Œæˆ**

---

### é˜¶æ®µ 2ï¼šAudioPolicyManager ä¿®æ”¹

#### æ­¥éª¤ 2.1ï¼šæ·»åŠ å¤´æ–‡ä»¶å’Œå®å®šä¹‰

**æ–‡ä»¶ï¼š** `frameworks/av/services/audiopolicy/managerdefault/AudioPolicyManager.cpp`

**ä¿®æ”¹ä½ç½®ï¼š** ç¬¬ 56-63 è¡Œï¼ˆåœ¨ `namespace android {` ä¹‹å‰ï¼‰

**æ·»åŠ å†…å®¹ï¼š**
```cpp
#include "AudioPolicyManager.h"
#include "TypeConverter.h"

// æ–°å¢ä»¥ä¸‹å†…å®¹ â†“
#include <android/log.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <stdio.h>
#include <unistd.h>
#define LOGH_TAG "APM_AudioPolicyManager"
#define LOGD(fmt, args...) __android_log_print(ANDROID_LOG_DEBUG, LOGH_TAG, fmt, ##args)

namespace android {
```

âœ… **å®Œæˆ**

---

#### æ­¥éª¤ 2.2ï¼šæ·»åŠ è®¾å¤‡åˆ‡æ¢é€»è¾‘

**æ–‡ä»¶ï¼š** `frameworks/av/services/audiopolicy/managerdefault/AudioPolicyManager.cpp`

**ä¿®æ”¹ä½ç½® 1ï¼š** ç¬¬ 2664 è¡Œï¼ˆå‡½æ•°å…¥å£ï¼‰

```cpp
ALOGV("%s() source %d, sampling rate %d, format %#x, channel mask %#x, session %d, "
      "flags %#x attributes=%s requested device ID %d",
      __func__, attr->source, config->sample_rate, config->format, config->channel_mask,
      session, flags, toString(*attr).c_str(), *selectedDeviceId);

LOGD("%s() enter", __func__ );    // â† æ–°å¢æ—¥å¿—
```

**ä¿®æ”¹ä½ç½® 2ï¼š** ç¬¬ 2669 è¡Œï¼ˆå˜é‡å£°æ˜ï¼‰

```cpp
// åŸä»£ç ï¼š
sp<DeviceDescriptor> device;

// ä¿®æ”¹ä¸ºï¼š
sp<DeviceDescriptor> device, tmp;    // â† æ·»åŠ  tmp ä¸´æ—¶å˜é‡
```

**ä¿®æ”¹ä½ç½® 3ï¼š** ç¬¬ 2776-2791 è¡Œï¼ˆè®¾å¤‡åˆ‡æ¢é€»è¾‘ï¼‰

åœ¨ `if (device == nullptr) { ... goto error; }` ä¹‹åï¼Œ`if (device->type() == AUDIO_DEVICE_IN_ECHO_REFERENCE)` ä¹‹å‰æ’å…¥ï¼š

```cpp
if (device == nullptr) {
    ALOGW("getInputForAttr() could not find device for source %d", attributes.source);
    status = BAD_VALUE;
    goto error;
}

// æ–°å¢ä»¥ä¸‹å†…å®¹ â†“
LOGD("device:%x ", device->type());
if (AUDIO_DEVICE_IN_BUILTIN_MIC == device->type() &&
    access("/data/vendor/HBG/ble", F_OK) == 0 &&
    config->sample_rate == 16000 &&
    config->format == 0x1 &&
    config->channel_mask == 0x10) {
    tmp = device;
    LOGD("getInputForAttr() try to getDevice \"hbg device\" ");
    device = mAvailableInputDevices.getDevice(AUDIO_DEVICE_IN_BLEHID,
                                          String8(""),
                                          AUDIO_FORMAT_PCM_16_BIT);
}
if (device == nullptr) {
    LOGD("getInputForAttr() could not find \"hbg device\" ");
    device = tmp;
}

if (device->type() == AUDIO_DEVICE_IN_ECHO_REFERENCE) {
```

**é€»è¾‘è¯´æ˜ï¼š**
1. æ£€æŸ¥å½“å‰è®¾å¤‡æ˜¯å¦ä¸º Built-in Mic
2. æ£€æŸ¥è§¦å‘æ–‡ä»¶ `/data/vendor/HBG/ble` æ˜¯å¦å­˜åœ¨
3. æ£€æŸ¥éŸ³é¢‘å‚æ•°æ˜¯å¦åŒ¹é…ï¼ˆ16kHz, PCM_16_BIT, MONOï¼‰
4. å°è¯•è·å– BLEHID è®¾å¤‡
5. å¦‚æœå¤±è´¥ï¼Œå›é€€åˆ°åŸè®¾å¤‡

âœ… **å®Œæˆ**

---

### é˜¶æ®µ 3ï¼šStreamIn HAL å±‚ä¿®æ”¹

#### æ­¥éª¤ 3.1ï¼šæ·»åŠ å¤´æ–‡ä»¶å’Œå®å®šä¹‰

**æ–‡ä»¶ï¼š** `hardware/interfaces/audio/core/all-versions/default/StreamIn.cpp`

**ä¿®æ”¹ä½ç½®ï¼š** ç¬¬ 34-39 è¡Œ

```cpp
#include <cmath>
#include <memory>

// æ–°å¢ä»¥ä¸‹å†…å®¹ â†“
#include <stdio.h>
#include <string.h>

#include <android/log.h>
#define LOGH_TAG "StreamInHAL"
#define LOGD(fmt, args...) __android_log_print(ANDROID_LOG_DEBUG, LOGH_TAG, fmt, ##args)

namespace android {
```

âœ… **å®Œæˆ**

---

#### æ­¥éª¤ 3.2ï¼šæ·»åŠ  HBG è®¾å¤‡ç‰¹æ®Šå¤„ç†

**ç›®çš„ï¼š** HBG_audio æ¨¡å—ä¸æ”¯æŒæŸäº›é«˜çº§éº¦å…‹é£åŠŸèƒ½ï¼Œéœ€è¦æå‰è¿”å› NOT_SUPPORTED

**ä¿®æ”¹ 3 ä¸ªå‡½æ•°ï¼š**

---

**å‡½æ•° 1ï¼šupdateSinkMetadata**

**ä¿®æ”¹ä½ç½®ï¼š** ç¬¬ 552-556 è¡Œ

```cpp
if (mDevice->version() < AUDIO_DEVICE_API_VERSION_3_2) {
    if (mStream->update_sink_metadata == nullptr) {
        return Result::NOT_SUPPORTED;
    }

    // æ–°å¢ HBG æ£€æŸ¥ â†“
    if (mDevice->device()->common.module->name != nullptr &&
        (strncmp("HBG_audio", mDevice->device()->common.module->name, strlen("HBG_audio")) == 0)) {
        LOGD("updateSinkMetadata  HBG_audio updateSinkMetadata NOT_SUPPORTED");
        return Result::NOT_SUPPORTED;
    }

    return doUpdateSinkMetadata(sinkMetadata);
```

---

**å‡½æ•° 2ï¼šsetMicrophoneDirection**

**ä¿®æ”¹ä½ç½®ï¼š** ç¬¬ 593-597 è¡Œ

```cpp
Return<Result> StreamIn::setMicrophoneDirection(MicrophoneDirection direction) {
    if (mStream->set_microphone_direction == nullptr) {
        return Result::NOT_SUPPORTED;
    }

    // æ–°å¢ HBG æ£€æŸ¥ â†“
    if (mDevice->device()->common.module->name != nullptr &&
        (strncmp("HBG_audio", mDevice->device()->common.module->name, strlen("HBG_audio")) == 0)) {
        LOGD("setMicrophoneDirection  HBG_audio setMicrophoneDirection NOT_SUPPORTED");
        return Result::NOT_SUPPORTED;
    }

    if (!common::utils::isValidHidlEnum(direction)) {
```

---

**å‡½æ•° 3ï¼šsetMicrophoneFieldDimension**

**ä¿®æ”¹ä½ç½®ï¼š** ç¬¬ 613-617 è¡Œ

```cpp
Return<Result> StreamIn::setMicrophoneFieldDimension(float zoom) {
    if (mStream->set_microphone_field_dimension == nullptr) {
        return Result::NOT_SUPPORTED;
    }

    // æ–°å¢ HBG æ£€æŸ¥ â†“
    if (mDevice->device()->common.module->name != nullptr &&
        (strncmp("HBG_audio", mDevice->device()->common.module->name, strlen("HBG_audio")) == 0)) {
        LOGD("setMicrophoneFieldDimension  HBG_audio setMicrophoneFieldDimension NOT_SUPPORTED");
        return Result::NOT_SUPPORTED;
    }

    if (std::isnan(zoom) || zoom < -1 || zoom > 1) {
```

âœ… **å®Œæˆ**

---

### é˜¶æ®µ 4ï¼šHIDL/AIDL æ¥å£ä¿®æ”¹

âš ï¸ **é‡è¦è¯´æ˜ï¼šéœ€è¦åŒæ—¶ä¿®æ”¹ 7.0 å’Œ 7.1 ç‰ˆæœ¬**

é€šè¿‡ `out/target/product/ross/vendor/etc/vintf/manifest.xml` ç¡®è®¤ï¼š
```xml
<name>android.hardware.audio</name>
<fqname>@7.1::IDevicesFactory/default</fqname>
```
**å®é™…ä½¿ç”¨ Audio HAL 7.1 ç‰ˆæœ¬**

---

#### æ­¥éª¤ 4.1ï¼šä¿®æ”¹ Audio Policy Configuration V7.0 æšä¸¾

**æ–‡ä»¶ 1ï¼š** `hardware/interfaces/audio/common/7.0/enums/include/android_audio_policy_configuration_V7_0-enums.h`

**ä¿®æ”¹ä½ç½®ï¼š** ç¬¬ 199 è¡Œï¼ˆisOutputDevice å‡½æ•°ä¸­çš„ input è®¾å¤‡åˆ¤æ–­ï¼‰

```cpp
case AudioDevice::AUDIO_DEVICE_IN_LOOPBACK:
case AudioDevice::AUDIO_DEVICE_IN_IP:
case AudioDevice::AUDIO_DEVICE_IN_BUS:
case AudioDevice::AUDIO_DEVICE_IN_BLEHID:        // â† æ–°å¢
case AudioDevice::AUDIO_DEVICE_IN_PROXY:
```

---

**æ–‡ä»¶ 2ï¼š** `hardware/interfaces/audio/7.0/config/audio_policy_configuration.xsd`

**ä¿®æ”¹ä½ç½®ï¼š** ç¬¬ 304 è¡Œï¼ˆAudioDevice æšä¸¾å®šä¹‰ï¼‰

```xml
<xs:enumeration value="AUDIO_DEVICE_IN_LOOPBACK"/>
<xs:enumeration value="AUDIO_DEVICE_IN_IP"/>
<xs:enumeration value="AUDIO_DEVICE_IN_BUS"/>
<xs:enumeration value="AUDIO_DEVICE_IN_BLEHID"/>    <!-- æ–°å¢ -->
<xs:enumeration value="AUDIO_DEVICE_IN_PROXY"/>
```

---

**æ–‡ä»¶ 3ï¼š** `hardware/interfaces/audio/7.0/config/api/current.txt`

**ä¿®æ”¹ä½ç½®ï¼š** ç¬¬ 97 è¡Œ

```
enum_constant public static final android.audio.policy.configuration.V7_0.AudioDevice AUDIO_DEVICE_IN_BLE_HEADSET;
enum_constant public static final android.audio.policy.configuration.V7_0.AudioDevice AUDIO_DEVICE_IN_BLEHID;    // â† æ–°å¢
enum_constant public static final android.audio.policy.configuration.V7_0.AudioDevice AUDIO_DEVICE_IN_BLUETOOTH_A2DP;
```

âœ… **å®Œæˆï¼ˆ7.0 ç‰ˆæœ¬ï¼‰**

---

#### æ­¥éª¤ 4.2ï¼šä¿®æ”¹ Audio Policy Configuration V7.1 æšä¸¾

**æ–‡ä»¶ 1ï¼š** `hardware/interfaces/audio/common/7.1/enums/include/android_audio_policy_configuration_V7_1-enums.h`

**ä¿®æ”¹ä½ç½®ï¼š** ç¬¬ 202 è¡Œ

```cpp
case AudioDevice::AUDIO_DEVICE_IN_LOOPBACK:
case AudioDevice::AUDIO_DEVICE_IN_IP:
case AudioDevice::AUDIO_DEVICE_IN_BUS:
case AudioDevice::AUDIO_DEVICE_IN_BLEHID:        // â† æ–°å¢
case AudioDevice::AUDIO_DEVICE_IN_PROXY:
```

---

**æ–‡ä»¶ 2ï¼š** `hardware/interfaces/audio/7.1/config/audio_policy_configuration.xsd`

**ä¿®æ”¹ä½ç½®ï¼š** ç¬¬ 310 è¡Œ

```xml
<xs:enumeration value="AUDIO_DEVICE_IN_LOOPBACK"/>
<xs:enumeration value="AUDIO_DEVICE_IN_IP"/>
<xs:enumeration value="AUDIO_DEVICE_IN_BUS"/>
<xs:enumeration value="AUDIO_DEVICE_IN_BLEHID"/>    <!-- æ–°å¢ -->
<xs:enumeration value="AUDIO_DEVICE_IN_PROXY"/>
```

---

**æ–‡ä»¶ 3ï¼š** `hardware/interfaces/audio/7.1/config/api/current.txt`

**ä¿®æ”¹ä½ç½®ï¼š** ç¬¬ 100 è¡Œ

```
enum_constant public static final android.audio.policy.configuration.V7_1.AudioDevice AUDIO_DEVICE_IN_BLE_HEADSET;
enum_constant public static final android.audio.policy.configuration.V7_1.AudioDevice AUDIO_DEVICE_IN_BLEHID;    // â† æ–°å¢
enum_constant public static final android.audio.policy.configuration.V7_1.AudioDevice AUDIO_DEVICE_IN_BLUETOOTH_A2DP;
```

âœ… **å®Œæˆï¼ˆ7.1 ç‰ˆæœ¬ï¼‰**

---

#### æ­¥éª¤ 4.3ï¼šæ·»åŠ  AIDL è½¬æ¢æ”¯æŒ

**æ–‡ä»¶ï¼š** `frameworks/av/media/audioaidlconversion/AidlConversionCppNdk.cpp`

**ä¿®æ”¹ä½ç½®ï¼š** ç¬¬ 508-511 è¡Œï¼ˆgetAudioDevicePairs å‡½æ•°ï¼‰

```cpp
{
    AUDIO_DEVICE_IN_BLUETOOTH_BLE, make_AudioDeviceDescription(
            AudioDeviceType::IN_DEVICE,
            GET_DEVICE_DESC_CONNECTION(BT_LE))
},
// æ–°å¢ä»¥ä¸‹å†…å®¹ â†“
{
    AUDIO_DEVICE_IN_BLEHID, make_AudioDeviceDescription(
            AudioDeviceType::IN_DEVICE)
},
{
    AUDIO_DEVICE_IN_ECHO_REFERENCE, make_AudioDeviceDescription(
            AudioDeviceType::IN_ECHO_REFERENCE)
}
```

âœ… **å®Œæˆ**

---

### é˜¶æ®µ 5ï¼šé…ç½®æ–‡ä»¶ä¿®æ”¹

#### æ­¥éª¤ 5.1ï¼šä¿®æ”¹éŸ³é¢‘ç­–ç•¥é…ç½®ï¼ˆå¼•å…¥ BLEHID æ¨¡å—ï¼‰

âš ï¸ **é‡è¦æ›´æ­£è¯´æ˜**

**é”™è¯¯æ–¹æ¡ˆï¼ˆå·²åºŸå¼ƒï¼‰**ï¼šä¿®æ”¹ `device/amlogic/common/audio/audio_policy_configuration_temp.xml`
**æ­£ç¡®æ–¹æ¡ˆ**ï¼šä¿®æ”¹ `device/amlogic/common/audio/tools/audio_policy_common_base.xml`

---

**æ­£ç¡®çš„ä¿®æ”¹æ–‡ä»¶ï¼š** `device/amlogic/common/audio/tools/audio_policy_common_base.xml`

**ä¿®æ”¹ä½ç½®ï¼š** ç¬¬ 145-146 è¡Œï¼ˆåœ¨ `</modules>` ä¹‹å‰ï¼Œbluetooth é…ç½®ä¹‹åï¼‰

```xml
<!-- Hearing aid Audio HAL -->
<xi:include href="hearing_aid_audio_policy_configuration.xml"/>
<xi:include href="bluetooth_audio_policy_configuration_7_0.xml"/>

<!-- HBG BLE Remote Audio HAL -->                           <!-- æ–°å¢ -->
<xi:include href="blehid_audio_policy_configuration.xml"/>  <!-- æ–°å¢ -->

<!-- MSD Audio HAL (optional) -->
<!-- <xi:include href="msd_audio_policy_configuration.xml"/> -->

</modules>
```

---

âš ï¸ **ä¸ Patch å·®å¼‚ï¼š**
- Patch ä¿®æ”¹ï¼š`frameworks/av/services/audiopolicy/config/audio_policy_configuration.xml`
- å®é™…ä¿®æ”¹ï¼š`device/amlogic/common/audio/tools/audio_policy_common_base.xml`ï¼ˆæºæ¨¡æ¿æ–‡ä»¶ï¼‰
- **åŸå› **ï¼šAmlogic å¹³å°ä½¿ç”¨ Python è„šæœ¬ä»æºæ¨¡æ¿åŠ¨æ€ç”Ÿæˆæœ€ç»ˆé…ç½®

---

**å®Œæ•´è¯æ®é“¾è¯´æ˜ï¼š**

### 1. **ä¸ºä»€ä¹ˆä¸èƒ½ä¿®æ”¹ temp æ–‡ä»¶ï¼Ÿ**

**ç¼–è¯‘æ—¶è‡ªåŠ¨å¤„ç†æµç¨‹**ï¼ˆè§ `device/amlogic/common/audio.mk:156-178`ï¼‰ï¼š

```makefile
# ç¬¬ 156 è¡Œï¼šç¼–è¯‘å¼€å§‹æ—¶åˆ é™¤æ—§çš„ temp æ–‡ä»¶
$(shell rm -rf device/amlogic/common/audio/audio_policy_configuration_temp.xml)

# ç¬¬ 160-165 è¡Œï¼šPython è„šæœ¬ä»æºæ¨¡æ¿é‡æ–°ç”Ÿæˆé…ç½®
$(shell python device/amlogic/common/audio/tools/buildAudioPolicyConfigurationXml.py \
    --odmDirName $(AUDIO_POLICY_BUILD_PARAM_ODM) \
    --chipDeviceType $(PRODUCT_DIR) \
    --soundbarProduct $(AUDIO_POLICY_BUILD_PARAM_SOUNDBAR) \
    --atvVersion $(AUDIO_POLICY_BUILD_PARAM_ATV_VERSION) \
    --productType $(AUDIO_POLICY_BUILD_PARAM_PRODUCT_TYPE))

# ç¬¬ 178 è¡Œï¼šå°†ç”Ÿæˆçš„æ–‡ä»¶å¤åˆ¶åˆ° temp ä½ç½®
$(shell cp $(AUDIO_POLICY_XML_PATH)/audio_policy_configuration$(AUDIO_FEATURE_TYPE).xml \
    device/amlogic/common/audio/audio_policy_configuration_temp.xml)
```

**ç»“è®º**ï¼šæ‰‹åŠ¨ä¿®æ”¹ `audio_policy_configuration_temp.xml` ä¼šåœ¨ç¼–è¯‘æ—¶è¢«**è¦†ç›–**ï¼Œä¿®æ”¹æ— æ•ˆï¼

---

### 2. **Python è„šæœ¬çš„å·¥ä½œæµç¨‹**

**è„šæœ¬ä½ç½®**ï¼š`device/amlogic/common/audio/tools/buildAudioPolicyConfigurationXml.py`

**å…³é”®ä»£ç åˆ†æ**ï¼ˆç¬¬ 204-206 è¡Œï¼‰ï¼š

```python
# è¯»å–åŸºç¡€æ¨¡æ¿ä½œä¸ºæºæ–‡ä»¶
audioPolicyCommonBaseXmlTree = ET.parse(AUDIO_POLICY_TOOLS_PATH + 'audio_policy_common_base.xml')
audioPolicyCommonBaseXmlRoot = audioPolicyCommonBaseXmlTree.getroot()
```

**å·¥ä½œæµç¨‹**ï¼š

```
ç¼–è¯‘å¼€å§‹
  â†“
audio.mk ç¬¬ 156 è¡Œï¼šåˆ é™¤ temp æ–‡ä»¶
  â†“
audio.mk ç¬¬ 160 è¡Œï¼šè°ƒç”¨ Python è„šæœ¬
  â†“
Python è¯»å–ï¼šaudio_policy_common_base.xml â† çœŸæ­£çš„æºå¤´ï¼
  â†“
Python æ ¹æ®äº§å“å‚æ•°ï¼ˆmbox/tvã€ms12/ddp/dtshdï¼‰åŠ¨æ€ç”Ÿæˆ
  â†“
ç”Ÿæˆå¤šä¸ªé…ç½®æ–‡ä»¶åˆ°ï¼šout/aml/audio/audio_policy_configuration_*.xml
  - audio_policy_configuration.xml
  - audio_policy_configuration_ms12.xml
  - audio_policy_configuration_ddp.xml
  - audio_policy_configuration_dtshd.xml
  - ... (å…± 8 ç§ç»„åˆ)
  â†“
audio.mk ç¬¬ 178 è¡Œï¼šé€‰æ‹©ä¸€ä¸ªå¤åˆ¶åˆ° temp ä½ç½®
  â†“
temp æ–‡ä»¶è¢«éƒ¨ç½²åˆ°ï¼švendor/etc/audio_policy_configuration.xml
```

**è¯æ®æ–‡ä»¶**ï¼š
- æºæ¨¡æ¿ï¼š`device/amlogic/common/audio/tools/audio_policy_common_base.xml`
- ç”Ÿæˆè„šæœ¬ï¼š`device/amlogic/common/audio/tools/buildAudioPolicyConfigurationXml.py:204`
- ç¼–è¯‘æ§åˆ¶ï¼š`device/amlogic/common/audio.mk:156-178`

---

### 3. **ä¸ºä»€ä¹ˆè¦ä¿®æ”¹æºæ¨¡æ¿æ–‡ä»¶ï¼Ÿ**

**audio_policy_common_base.xml** æ˜¯æ‰€æœ‰ç”Ÿæˆé…ç½®çš„**å”¯ä¸€æºå¤´**ï¼Œä¿®æ”¹å®ƒå¯ä»¥ï¼š

âœ… **ä¿è¯æ‰€æœ‰é…ç½®å˜ä½“éƒ½åŒ…å« blehid**
- æ— è®ºç¼–è¯‘ ms12ã€ddpã€dtshd è¿˜æ˜¯é»˜è®¤ç‰ˆæœ¬ï¼Œéƒ½ä¼šåŒ…å« blehid é…ç½®
- é¿å…é—æ¼ä»»ä½•é…ç½®ç»„åˆ

âœ… **æŒä¹…åŒ–ä¿®æ”¹**
- temp æ–‡ä»¶æ¯æ¬¡ç¼–è¯‘éƒ½ä¼šè¢«åˆ é™¤å¹¶é‡æ–°ç”Ÿæˆ
- æºæ¨¡æ¿æ–‡ä»¶çš„ä¿®æ”¹ä¼šä¸€ç›´ä¿ç•™

âœ… **ç¬¦åˆ Amlogic çš„è®¾è®¡æ¨¡å¼**
- Amlogic é€šè¿‡ Python è„šæœ¬å®ç°"ä¸€ä»½æºæ¨¡æ¿ â†’ å¤šç§é…ç½®å˜ä½“"
- è¿™æ˜¯ Amlogic å¹³å°çš„æ ‡å‡†åšæ³•

---

### 4. **å®é™…éªŒè¯è¿‡ç¨‹**

**é—®é¢˜å‘ç°**ï¼š
```bash
# ç¼–è¯‘åæ£€æŸ¥æœ€ç»ˆé…ç½®æ–‡ä»¶
$ grep "blehid" out/target/product/ross/vendor/etc/audio_policy_configuration.xml
# è¾“å‡ºï¼šæ— ç»“æœ âŒ

# ä½† blehid é…ç½®æ–‡ä»¶ç¡®å®è¢«å¤åˆ¶äº†
$ ls out/target/product/ross/vendor/etc/blehid_audio_policy_configuration.xml
# è¾“å‡ºï¼šæ–‡ä»¶å­˜åœ¨ âœ…
```

**åŸå› åˆ†æ**ï¼š
- `blehid_audio_policy_configuration.xml` æ–‡ä»¶è¢«å¤åˆ¶åˆ°äº† vendor/etc/
- ä½†ä¸»é…ç½®æ–‡ä»¶ `audio_policy_configuration.xml` ä¸­æ²¡æœ‰å¼•å…¥å®ƒï¼ˆç¼ºå°‘ `<xi:include>`ï¼‰
- å› ä¸º Python è„šæœ¬ä»æºæ¨¡æ¿é‡æ–°ç”Ÿæˆï¼Œè¦†ç›–äº†æ‰‹åŠ¨ä¿®æ”¹

**æœ€ç»ˆé…ç½®æ–‡ä»¶æœ«å°¾**ï¼ˆå¯è§æ‰€æœ‰å¼•ç”¨çš„å­æ¨¡å—ï¼‰ï¼š
```xml
<xi:include href="usb_audio_policy_configuration.xml" />
<xi:include href="r_submix_audio_policy_configuration.xml" />
<xi:include href="hearing_aid_audio_policy_configuration.xml" />
<xi:include href="bluetooth_audio_policy_configuration_7_0.xml" />
<!-- âŒ ç¼ºå°‘ blehid çš„å¼•ç”¨ï¼ -->
</modules>
```

---

### 5. **ä¸ AOSP æ ‡å‡†è·¯å¾„çš„å·®å¼‚**

| å¹³å° | é…ç½®æ–‡ä»¶ä½ç½® | ä¿®æ”¹æ–¹å¼ | ç”Ÿæˆæ–¹å¼ |
|------|-------------|---------|---------|
| **AOSP æ ‡å‡†** | `frameworks/av/services/audiopolicy/config/` | ç›´æ¥ä¿®æ”¹ XML | é™æ€æ–‡ä»¶ï¼Œç›´æ¥å¤åˆ¶ |
| **Amlogic å¹³å°** | `device/amlogic/common/audio/tools/` | ä¿®æ”¹æºæ¨¡æ¿ | Python åŠ¨æ€ç”Ÿæˆå¤šç§å˜ä½“ |

**Amlogic æ–¹æ¡ˆçš„ä¼˜åŠ¿**ï¼š
- æ”¯æŒ 8 ç§éŸ³é¢‘ç‰¹æ€§ç»„åˆï¼ˆms12ã€ms12_v1ã€ddpã€dtshdã€dtsx ç­‰åŠå…¶ç»„åˆï¼‰
- æ— éœ€ä¸ºæ¯ç§ç»„åˆç»´æŠ¤ç‹¬ç«‹çš„å®Œæ•´é…ç½®æ–‡ä»¶
- é€šè¿‡ä¸€ä»½æºæ¨¡æ¿ + å‚æ•°åŒ–ç”Ÿæˆï¼Œå‡å°‘ç»´æŠ¤æˆæœ¬

---

### 6. **æ€»ç»“ï¼šæ­£ç¡®çš„ä¿®æ”¹ä½ç½®**

| ä¿®æ”¹å†…å®¹ | æ­£ç¡®ä½ç½® | åŸå›  |
|---------|---------|------|
| âœ… **XML å¼•ç”¨** | `audio_policy_common_base.xml` ç¬¬ 145-146 è¡Œ | æºæ¨¡æ¿æ–‡ä»¶ï¼Œæ‰€æœ‰é…ç½®çš„å”¯ä¸€æºå¤´ |
| âœ… **é…ç½®æ–‡ä»¶å¤åˆ¶** | `vendor/giec/device-giec.mk` ç¬¬ 83-84 è¡Œ | å°† blehid é…ç½®æ–‡ä»¶å¤åˆ¶åˆ° vendor/etc/ |
| âœ… **HAL æ¨¡å—å®‰è£…** | `vendor/giec/device-giec.mk` ç¬¬ 79-81 è¡Œ | å®‰è£… HAL åº“æ–‡ä»¶ |
| âŒ **é”™è¯¯ä½ç½®** | ~~`audio_policy_configuration_temp.xml`~~ | ç¼–è¯‘æ—¶è‡ªåŠ¨ç”Ÿæˆï¼Œæ‰‹åŠ¨ä¿®æ”¹ä¼šè¢«è¦†ç›– |

âœ… **å®Œæˆï¼ˆå·²ä¿®æ­£ï¼‰**

---

#### æ­¥éª¤ 5.2ï¼šä¿®æ”¹ init.rcï¼ˆæ·»åŠ è¿è¡Œæ—¶ç›®å½•ï¼‰

**æ–‡ä»¶ï¼š** `device/amlogic/common/products/mbox/init.amlogic.system.rc`

**ä¿®æ”¹ä½ç½®ï¼š** ç¬¬ 206-208 è¡Œï¼ˆæ–‡ä»¶æœ«å°¾ï¼‰

```bash
# Enable console for user builds when ro.boot.enableconsole=1
on post-fs-data && property:ro.boot.enableconsole=1
    start console

# HBG BLE Remote Audio HAL                              # æ–°å¢
on post-fs-data                                         # æ–°å¢
    mkdir /data/vendor/HBG 0770 audioserver audioserver # æ–°å¢
    symlink /vendor/etc/remote.txt /data/vendor/HBG/remote.txt  # æ–°å¢
```

**åŠŸèƒ½è¯´æ˜ï¼š**
1. åˆ›å»º `/data/vendor/HBG` ç›®å½•ï¼Œæƒé™ 0770ï¼Œå±ä¸» audioserver
2. åˆ›å»ºè½¯é“¾æ¥ï¼š`/data/vendor/HBG/remote.txt` â†’ `/vendor/etc/remote.txt`
3. HAL å±‚ä¼šåˆ›å»º `/data/vendor/HBG/ble` æ–‡ä»¶ä½œä¸ºè§¦å‘æ ‡å¿—

âš ï¸ **ä¸ Patch å·®å¼‚ï¼š**
- Patch æ–¹æ¡ˆï¼šåˆ›å»ºç‹¬ç«‹çš„ `init.hbg.remote.rc` æ–‡ä»¶
- å®é™…æ–¹æ¡ˆï¼šç›´æ¥ä¿®æ”¹ `init.amlogic.system.rc`
- **åŸå› **ï¼šç®€åŒ–é›†æˆï¼Œé¿å…é¢å¤–æ–‡ä»¶å’Œå¼•ç”¨é…ç½®

âœ… **å®Œæˆ**

---

## å››ã€å®Œæ•´ä¿®æ”¹æ–‡ä»¶æ¸…å•

### 4.1 æ–°å¢æ–‡ä»¶ï¼ˆ6 ä¸ªï¼‰

| # | æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|---|---------|------|
| 1 | `vendor/giec/executable/hbg/audio.blehid.default.so` | HBG Audio HAL å®ç°ï¼ˆ32-bit ARMï¼‰ |
| 2 | `vendor/giec/executable/hbg/libhbgdecode.so` | HBG éŸ³é¢‘è§£ç åº“ï¼ˆ32-bit ARMï¼‰ |
| 3 | `vendor/giec/executable/hbg/remote.txt` | é¥æ§å™¨é…ç½®ï¼ˆVID=0x000d, PID=0x3838ï¼‰ |
| 4 | `vendor/giec/executable/hbg/Android.mk` | ç¼–è¯‘é…ç½®æ–‡ä»¶ |
| 5 | `device/amlogic/common/audio/blehid_audio_policy_configuration.xml` | âœ… **BLEHID éŸ³é¢‘ç­–ç•¥é…ç½®æ–‡ä»¶** |
| 6 | `device/amlogic/common/keyboards/Vendor_000d_Product_3838.kl` | âœ… **è“ç‰™é¥æ§å™¨é”®ç›˜å¸ƒå±€æ–‡ä»¶** |

---

### 4.2 ä¿®æ”¹çš„ç³»ç»Ÿæ–‡ä»¶ï¼ˆ19 ä¸ªï¼‰

| # | æ–‡ä»¶è·¯å¾„ | è¡Œå· | ä¿®æ”¹å†…å®¹ |
|---|---------|------|---------|
| **ç³»ç»Ÿæ¡†æ¶å±‚ï¼ˆ2 ä¸ªï¼‰** |
| 1 | `system/media/audio/include/system/audio-hal-enums.h` | 395 | æ·»åŠ  BLEHID è®¾å¤‡å®šä¹‰ |
| 2 | `system/media/audio/include/system/audio-base-utils.h` | 120, 266 | æ·»åŠ åˆ°è®¾å¤‡é›†åˆå’Œæ•°ç»„ |
| **AudioPolicyManagerï¼ˆ1 ä¸ªï¼‰** |
| 3 | `frameworks/av/services/audiopolicy/managerdefault/AudioPolicyManager.cpp` | 56-63, 2664, 2669, 2776-2791 | å¤´æ–‡ä»¶ã€æ—¥å¿—ã€è®¾å¤‡åˆ‡æ¢é€»è¾‘ |
| **HAL å±‚ï¼ˆ1 ä¸ªï¼‰** |
| 4 | `hardware/interfaces/audio/core/all-versions/default/StreamIn.cpp` | 34-39, 552-556, 593-597, 613-617 | å¤´æ–‡ä»¶ã€3 ä¸ªå‡½æ•° HBG æ£€æŸ¥ |
| **HIDL/AIDL V7.0ï¼ˆ3 ä¸ªï¼‰** |
| 5 | `hardware/interfaces/audio/common/7.0/enums/include/android_audio_policy_configuration_V7_0-enums.h` | 199 | æ·»åŠ åˆ°è¾“å…¥è®¾å¤‡åˆ¤æ–­ |
| 6 | `hardware/interfaces/audio/7.0/config/audio_policy_configuration.xsd` | 304 | æ·»åŠ  XSD æšä¸¾ |
| 7 | `hardware/interfaces/audio/7.0/config/api/current.txt` | 96-97 | æ·»åŠ  API å®šä¹‰ï¼ˆä¿®æ­£é¡ºåºï¼šBLEHID åœ¨ BLE_HEADSET å‰ï¼‰|
| **HIDL/AIDL V7.1ï¼ˆ3 ä¸ªï¼‰** |
| 8 | `hardware/interfaces/audio/common/7.1/enums/include/android_audio_policy_configuration_V7_1-enums.h` | 202 | æ·»åŠ åˆ°è¾“å…¥è®¾å¤‡åˆ¤æ–­ |
| 9 | `hardware/interfaces/audio/7.1/config/audio_policy_configuration.xsd` | 310 | æ·»åŠ  XSD æšä¸¾ |
| 10 | `hardware/interfaces/audio/7.1/config/api/current.txt` | 99-100 | æ·»åŠ  API å®šä¹‰ï¼ˆä¿®æ­£é¡ºåºï¼šBLEHID åœ¨ BLE_HEADSET å‰ï¼‰|
| **AIDL è½¬æ¢ï¼ˆ1 ä¸ªï¼‰** |
| 11 | `frameworks/av/media/audioaidlconversion/AidlConversionCppNdk.cpp` | 508-511 | æ·»åŠ è®¾å¤‡ç±»å‹æ˜ å°„ |
| **é…ç½®æ–‡ä»¶ï¼ˆ8 ä¸ªï¼‰** |
| 12 | `device/amlogic/common/audio/blehid_audio_policy_configuration.xml` | å…¨éƒ¨ | ä» patch å¤åˆ¶ï¼ˆæ–°æ–‡ä»¶ï¼‰ |
| 13 | `device/amlogic/common/audio/tools/audio_policy_common_base.xml` | 145-146 | âœ… **å¼•å…¥ blehid æ¨¡å—ï¼ˆæºæ¨¡æ¿æ–‡ä»¶ï¼‰** |
| 14 | `device/amlogic/common/audio/Android.bp` | 86-103 | âœ… **æ–°å¢ blehid Android.bp æ¨¡å—å®šä¹‰** |
| 15 | `device/amlogic/common/audio/audio_policy/common/Android.bp` | 58 | âœ… **å°† blehid æ·»åŠ åˆ° audio_policy_configuration_files** |
| 16 | `device/amlogic/common/products/mbox/init.amlogic.system.rc` | 206-208 | æ·»åŠ  HBG ç›®å½•å’Œè½¯é“¾æ¥ |
| 17 | `device/amlogic/common/keyboards/Vendor_000d_Product_3838.kl` | å…¨éƒ¨ | âœ… **æ–°å¢è“ç‰™é¥æ§å™¨é”®ç›˜å¸ƒå±€æ–‡ä»¶** |
| 18 | `device/amlogic/common/products/mbox/s7d/files/hbg_ble/ble/b01_8.0/system/etc/remote.txt` | 1-2 | âœ… **æ›´æ–° VID/PID é…ç½®** |
| 19 | `vendor/giec/device-giec.mk` | 77-84 | æ·»åŠ  HBG æ¨¡å—åˆ° PRODUCT_PACKAGES |

---

## äº”ã€å…³é”®æŠ€æœ¯ç»†èŠ‚

### 5.1 è®¾å¤‡ç±»å‹å€¼è®¾è®¡

```c
AUDIO_DEVICE_IN_BLEHID = AUDIO_DEVICE_BIT_IN | 0x200000u
                       = 0x80000000 | 0x200000
                       = 0x80200000
```

**å€¼å†²çªåˆ†æï¼š**
- âŒ çœ‹ä¼¼å†²çªï¼š`AUDIO_DEVICE_OUT_AUX_LINE = 0x200000u` (ç¬¬ 362 è¡Œ)
- âœ… å®é™…æ— å†²çªï¼š
  - è¾“å‡ºè®¾å¤‡ï¼š0x00200000ï¼ˆæœ€é«˜ä½ = 0ï¼‰
  - è¾“å…¥è®¾å¤‡ï¼š0x80200000ï¼ˆæœ€é«˜ä½ = 1ï¼‰
  - é€šè¿‡ `AUDIO_DEVICE_BIT_IN = 0x80000000` æ ‡å¿—ä½åŒºåˆ†

---

### 5.2 éŸ³é¢‘å‚æ•°åŒ¹é…

```c
config->sample_rate == 16000        // é‡‡æ ·ç‡ 16kHz
config->format == 0x1               // AUDIO_FORMAT_PCM_16_BIT
config->channel_mask == 0x10        // AUDIO_CHANNEL_IN_MONO
```

**å‚æ•°å«ä¹‰ï¼š**
- `0x1`ï¼š`AUDIO_FORMAT_PCM_16_BIT`ï¼ˆ16ä½ PCM ç¼–ç ï¼‰
- `0x10`ï¼š`AUDIO_CHANNEL_IN_MONO`ï¼ˆå•å£°é“è¾“å…¥ï¼‰

---

### 5.3 è§¦å‘æœºåˆ¶

```
é¥æ§å™¨æŒ‰ä¸‹è¯­éŸ³é”®
    â†“
HAL å±‚åˆ›å»ºæ–‡ä»¶ï¼š/data/vendor/HBG/ble
    â†“
AudioPolicyManager æ£€æµ‹åˆ°æ–‡ä»¶ï¼ˆaccess() == 0ï¼‰
    â†“
åˆ‡æ¢è®¾å¤‡ï¼šBUILTIN_MIC â†’ BLEHID
    â†“
å½•éŸ³æ•°æ®é€šè¿‡ audio.blehid.default.so å¤„ç†
```

---

### 5.4 Audio HAL ç‰ˆæœ¬åˆ¤æ–­

**é”™è¯¯åˆ¤æ–­ä¾æ®ï¼š**
```xml
<!-- audio_policy_configuration_temp.xml:2 -->
<audioPolicyConfiguration version="7.0">
```
âŒ è¿™æ˜¯ **audioPolicyConfiguration çš„ç‰ˆæœ¬**ï¼Œä¸æ˜¯ Audio HAL ç‰ˆæœ¬

**æ­£ç¡®åˆ¤æ–­ä¾æ®ï¼š**
```xml
<!-- out/target/product/ross/vendor/etc/vintf/manifest.xml -->
<hal format="hidl">
    <name>android.hardware.audio</name>
    <transport>hwbinder</transport>
    <fqname>@7.1::IDevicesFactory/default</fqname>    â† Audio HAL 7.1
</hal>
```
âœ… **å®é™…ä½¿ç”¨ Audio HAL 7.1**

---

## å…­ã€ç¼–è¯‘ä¸éªŒè¯

### 6.1 ç¼–è¯‘å‘½ä»¤

```bash
# æ–¹æ¡ˆ 1ï¼šå®Œæ•´ç¼–è¯‘
make clean
make -j$(nproc)

# æ–¹æ¡ˆ 2ï¼šåªç¼–è¯‘ç›¸å…³æ¨¡å—
mmm frameworks/av/services/audiopolicy
mmm hardware/interfaces/audio
mmm system/media/audio
mmm vendor/giec/executable/hbg
```

---

### 6.2 éªŒè¯æ­¥éª¤ï¼ˆä¾›åº”å•†æ–‡æ¡£ï¼‰

#### A. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æ­£ç¡®éƒ¨ç½²

```bash
adb shell ls -l /vendor/lib/libhbgdecode.so
adb shell ls -l /vendor/lib/hw/audio.blehid.default.so
adb shell ls -l /vendor/etc/blehid_audio_policy_configuration.xml
adb shell ls -l /vendor/etc/remote.txt
```

**é¢„æœŸè¾“å‡ºï¼š** æ‰€æœ‰æ–‡ä»¶å­˜åœ¨ä¸”æƒé™æ­£ç¡®

```bash
-rw-r--r-- 1 root root 46344 2009-01-01 00:00 /vendor/lib/libhbgdecode.so
-rw-r--r-- 1 root root 21884 2009-01-01 00:00 /vendor/lib/hw/audio.blehid.default.so
-rw-r--r-- 1 root root 785 2009-01-01 00:00 /vendor/etc/blehid_audio_policy_configuration.xml
-rw-r--r-- 1 root root 204 2009-01-01 00:00 /vendor/etc/remote.txt
```

---

#### B. æ£€æŸ¥è¿è¡Œæ—¶é…ç½®

```bash
# 1. æ£€æŸ¥ remote.txt æ˜¯å¦è¢«å¤åˆ¶
adb root
adb shell cat /data/vendor/HBG/remote.txt
# åº”è¾“å‡ºï¼šVENDOR_ID:0x000d, PRODUCT_ID:0x3838

# 2. æ£€æŸ¥éŸ³é¢‘ç­–ç•¥é…ç½®æ˜¯å¦åŒ…å« BLEHID æ¨¡å—
adb shell cat /vendor/etc/audio_policy_configuration.xml | grep -A 5 "blehid"
# åº”åŒ…å«ï¼š<xi:include href="blehid_audio_policy_configuration.xml"/>
```

---

#### C. æ£€æŸ¥ hidraw è®¾å¤‡æƒé™

```bash
adb shell "ls -l /dev/hidraw*"
# å¿…é¡»å…ˆè¿æ¥è“ç‰™é¥æ§å™¨
# æƒé™åº”ä¸ºï¼šcrw-rw---- (660)
# é¢„æœŸç»“æœï¼šcrw-rw---- 1 system audio 509,   0 2025-11-13 02:42 /dev/hidraw0
```

---

#### D. æ£€æŸ¥éŸ³é¢‘æ¨¡å—æ˜¯å¦åŠ è½½

```bash
adb shell dumpsys media.audio_policy | grep -A 10 "blehid"
```

**é¢„æœŸè¾“å‡ºï¼š**
```
adb shell dumpsys media.audio_policy | grep -A 10 "blehid"               â”€â•¯
  5. Handle: 42; "blehid"
   - Input MixPorts (1):
      1. "blehid input"; 0x0000 (AUDIO_INPUT_FLAG_NONE)
       - Profiles (1):
          1. ""; AUDIO_FORMAT_PCM_16_BIT (0x1)
             sampling rates: 16000
             channel masks: 0x0010
             AUDIO_ENCAPSULATION_TYPE_NONE
       - Supported devices (1):
        1. Port ID: 19; "hbg_audio"; {AUDIO_DEVICE_IN_BLEHID, @:}
           Encapsulation modes: 0, metadata types: 0
       - maxOpenCount: 1; curOpenCount: 0
       - maxActiveCount: 1; curActiveCount: 0
```

âš ï¸ **æ³¨æ„**ï¼šHandle å€¼ä¸åº”ä¸º 0

---

#### E. è¿æ¥é¥æ§å™¨åæ£€æŸ¥è®¾å¤‡ä¿¡æ¯

```bash
# æ³¨æ„è¿™ä¸ªevent9æ˜¯è¿æ¥è“ç‰™é¥æ§å™¨ä¹‹åä½¿ç”¨`getevent` çœ‹é¥æ§å™¨æ˜¯å“ªä¸ªè¾“å‡ºå¾—åˆ°çš„
adb shell dumpsys input | grep -A 10 "event9"
```

**é¢„æœŸè¾“å‡ºï¼š**
```
Path: /dev/input/event9
      Enabled: true
      Descriptor: ef8ffbb99fcc424f30847854224be921e3ed7a9d
      Location: dc:2e:97:ac:ab:a3
      ControllerNumber: 0
      UniqueId: cb:04:00:5b:2d:e1
      Identifier: bus=0x0005, vendor=0x000d, product=0x3838, version=0x0101, bluetoothAddress=CB:04:00:5B:2D:E1
      KeyLayoutFile: /vendor/usr/keylayout/Vendor_000d_Product_3838.kl
      KeyCharacterMapFile: /system/usr/keychars/Generic.kcm
      LanguageTag:
      LayoutType:
```

**éªŒè¯ç‚¹ï¼š**
- vendor=0x000d åº”ä¸ `/vendor/etc/remote.txt` ä¸­çš„ `VENDOR_ID` åŒ¹é…
- product=0x3838 åº”ä¸ `PRODUCT_ID` åŒ¹é…

âŒ **å¦‚æœä¸åŒ¹é…**ï¼šä¿®æ”¹ `vendor/giec/executable/hbg/remote.txt` å¹¶é‡æ–°ç¼–è¯‘

---

#### F. æ£€æŸ¥ BLE è§¦å‘æ–‡ä»¶

```bash
# å…ˆè¿æ¥é¥æ§å™¨ï¼Œç­‰å¾… 10 ç§’
adb shell ls -l /data/vendor/HBG/ble
# é¢„æœŸç»“æœï¼š-rwxrwxrwx 1 audioserver audio   0 2025-11-13 03:10 ble
```

**å¦‚æœæ˜¾ç¤º "No such file or directory"ï¼š**

1. ä¸´æ—¶å…³é—­ SELinuxï¼š
   ```bash
   adb shell setenforce 0
   ```

2. é‡æ–°è¿æ¥è“ç‰™é¥æ§å™¨

---

#### G. æµ‹è¯•å½•éŸ³åŠŸèƒ½

```bash
# å®‰è£…æµ‹è¯• APP
adb install bt-remote-patch/RecordTool.apk

# ä½¿ç”¨é¥æ§å™¨æ“ä½œï¼š
# 1. æŒ‰ä¸‹ UI ç•Œé¢ "å¼€å§‹å½•éŸ³" æŒ‰é’®
# 2. æŒ‰ä¸‹é¥æ§å™¨è¯­éŸ³é”®å¹¶è¯´è¯æµ‹è¯•
# 3. é‡Šæ”¾è¯­éŸ³é”®åœæ­¢å½•éŸ³ï¼Œç„¶åæ‰‹åŠ¨æŒ‰ä¸‹ UI ç•Œé¢ "åœæ­¢å½•éŸ³" æŒ‰é’®
# 4. æŒ‰ä¸‹ UI ç•Œé¢ "æ’­æ”¾å½•éŸ³æŒ‰é’®" æ£€æŸ¥å½•éŸ³æ˜¯å¦æ­£å¸¸å·¥ä½œ
```

---

#### H. æŸ¥çœ‹æ—¥å¿—(å¯ä»¥ä¸åš)

```bash
# æŸ¥çœ‹ AudioPolicyManager æ—¥å¿—
adb logcat | grep "APM_AudioPolicyManager"

# æŸ¥çœ‹ StreamIn HAL æ—¥å¿—
adb logcat | grep "StreamInHAL"
```

**é¢„æœŸæ—¥å¿—ï¼š**
```
APM_AudioPolicyManager: getInputForAttr() enter
APM_AudioPolicyManager: device:0x80000004
APM_AudioPolicyManager: getInputForAttr() try to getDevice "hbg device"
```

å¦‚æœçœ‹åˆ° "could not find hbg device"ï¼Œæ£€æŸ¥ï¼š
1. blehid_audio_policy_configuration.xml æ˜¯å¦è¢«æ­£ç¡®å¼•å…¥
2. audio.blehid.default.so æ˜¯å¦æ­£ç¡®åŠ è½½

---

## ä¸ƒã€å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### Q1ï¼šç¼–è¯‘é”™è¯¯ - æœªå®šä¹‰ AUDIO_DEVICE_IN_BLEHID

**é”™è¯¯ä¿¡æ¯ï¼š**
```
error: 'AUDIO_DEVICE_IN_BLEHID' was not declared in this scope
```

**è§£å†³æ–¹æ¡ˆï¼š**
1. ç¡®è®¤ `system/media/audio/include/system/audio-hal-enums.h:395` å·²æ­£ç¡®ä¿®æ”¹
2. æ‰§è¡Œ `make clean` æ¸…ç†ç¼“å­˜
3. é‡æ–°ç¼–è¯‘

---

### Q2ï¼šè¿è¡Œæ—¶æ‰¾ä¸åˆ° BLEHID è®¾å¤‡

**æ—¥å¿—ï¼š**
```
APM_AudioPolicyManager: getInputForAttr() could not find "hbg device"
```

**è§£å†³æ–¹æ¡ˆï¼š**
1. æ£€æŸ¥ `dumpsys media.audio_policy` è¾“å‡ºæ˜¯å¦åŒ…å« blehid æ¨¡å—
2. æ£€æŸ¥ `/vendor/etc/audio_policy_configuration.xml` æ˜¯å¦åŒ…å«ï¼š
   ```xml
   <xi:include href="blehid_audio_policy_configuration.xml"/>
   ```
3. æ£€æŸ¥åº“æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼š
   ```bash
   ls -l /vendor/lib/hw/audio.blehid.default.so
   ```

---

### Q3ï¼š/data/vendor/HBG/ble æ–‡ä»¶ä¸å­˜åœ¨

**åŸå› ï¼š** SELinux æƒé™é™åˆ¶

**è§£å†³æ–¹æ¡ˆï¼ˆå¼€å‘é˜¶æ®µï¼‰ï¼š**
```bash
adb shell setenforce 0
```

**ç”Ÿäº§ç¯å¢ƒè§£å†³æ–¹æ¡ˆï¼š** é…ç½®æ­£ç¡®çš„ SELinux ç­–ç•¥ï¼ˆéœ€è¦å•ç‹¬ç¼–å†™ .te æ–‡ä»¶ï¼‰

---

### Q4ï¼šå½•éŸ³ä½¿ç”¨çš„ä»æ˜¯ Built-in Mic

**æ£€æŸ¥æ¸…å•ï¼š**

1. âœ… `/data/vendor/HBG/ble` æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Ÿ
   ```bash
   adb shell ls -l /data/vendor/HBG/ble
   ```

2. âœ… éŸ³é¢‘å‚æ•°æ˜¯å¦åŒ¹é…ï¼Ÿ
   - é‡‡æ ·ç‡ï¼š16000Hz
   - æ ¼å¼ï¼šPCM_16_BIT
   - å£°é“ï¼šMONO

3. âœ… AudioPolicyManager æ—¥å¿—æ˜¯å¦æ­£å¸¸ï¼Ÿ
   ```bash
   adb logcat | grep "APM_AudioPolicyManager"
   ```

4. âœ… remote.txt ä¸­çš„ VID/PID æ˜¯å¦æ­£ç¡®ï¼Ÿ
   ```bash
   adb shell cat /vendor/etc/remote.txt
   adb shell dumpsys input | grep "Identifier"
   ```

---

### Q5ï¼šé¥æ§å™¨ VID/PID ä¸åŒ¹é…

**ç—‡çŠ¶ï¼š** HAL å±‚æ— æ³•è¯†åˆ«é¥æ§å™¨

**è§£å†³æ–¹æ¡ˆï¼š**

1. æŸ¥çœ‹å®é™…è®¾å¤‡ä¿¡æ¯ï¼š
   ```bash
   adb shell dumpsys input | grep -A 5 "é¥æ§å™¨åç§°"
   ```

2. ä¿®æ”¹ `vendor/giec/executable/hbg/remote.txt`ï¼š
   ```
   VENDOR_ID:0xå®é™…vendor
   PRODUCT_ID:0xå®é™…product
   ```

3. é‡æ–°ç¼–è¯‘å¹¶åˆ·æœº

---

## å…«ã€ä¸ Patch çš„å®Œæ•´å·®å¼‚å¯¹æ¯”

| é¡¹ç›® | Patch åŸæ–¹æ¡ˆ | å®é™…æ‰§è¡Œæ–¹æ¡ˆ | å·®å¼‚åŸå›  |
|------|-------------|-------------|---------|
| **åº“æ–‡ä»¶è·¯å¾„** | `device/amlogic/common/prebuilt/audio/hw/`<br>`device/amlogic/common/prebuilt/audio/` | `vendor/giec/executable/hbg/` | 1. åŸè·¯å¾„ä¸å­˜åœ¨<br>2. å¤ç”¨ç°æœ‰ vendor/giec ç»“æ„<br>3. å‚è€ƒ MPTools æ¨¡å¼<br>4. ä½¿ç”¨ Android.mk è€Œé PRODUCT_COPY_FILES |
| **é¥æ§å™¨é…ç½®** | `VENDOR_ID:0x1d5a`<br>`PRODUCT_ID:0xc081` | `VENDOR_ID:0x000d`<br>`PRODUCT_ID:0x3838` | æ ¹æ®å®é™…è®¾å¤‡ `dumpsys input` æ•°æ®ä¿®æ”¹ |
| **init.rc** | åˆ›å»ºæ–°æ–‡ä»¶ï¼š<br>`device/amlogic/xxx/init.hbg.remote.rc` | ç›´æ¥ä¿®æ”¹ï¼š<br>`device/amlogic/common/products/mbox/init.amlogic.system.rc` | 1. ç®€åŒ–é›†æˆ<br>2. é¿å…é¢å¤–æ–‡ä»¶<br>3. æ— éœ€ä¿®æ”¹ import åˆ—è¡¨ |
| **éŸ³é¢‘é…ç½®** | `frameworks/av/services/audiopolicy/config/audio_policy_configuration.xml` | `device/amlogic/common/audio/audio_policy_configuration_temp.xml` | Amlogic å¹³å°ä½¿ç”¨å®šåˆ¶é…ç½®æ–‡ä»¶ |
| **Audio HAL 7.1** | Patch åŒ…å« | åˆå§‹é—æ¼ï¼Œåè¡¥å…… | é€šè¿‡ manifest ç¡®è®¤å®é™…ä½¿ç”¨ 7.1 |
| **ç¼–è¯‘æ–¹å¼** | ä½¿ç”¨ PRODUCT_COPY_FILES | ä½¿ç”¨ Android.mk | æ›´ç¬¦åˆ vendor/giec ç°æœ‰æ¨¡å¼ |

---

## ä¹ã€æŠ€æœ¯å€ºåŠ¡ä¸æœªæ¥ä¼˜åŒ–

### 9.1 å·²çŸ¥é™åˆ¶

1. **SELinux ç­–ç•¥æœªé…ç½®**
   - å½“å‰éœ€è¦ `setenforce 0` æ‰èƒ½åˆ›å»º `/data/vendor/HBG/ble`
   - ç”Ÿäº§ç¯å¢ƒéœ€è¦ç¼–å†™ .te æ–‡ä»¶

2. **ä»…æ”¯æŒå•ä¸€é¥æ§å™¨å‹å·**
   - VID/PID ç¡¬ç¼–ç åœ¨ remote.txt ä¸­
   - æœªæ¥å¯èƒ½éœ€è¦æ”¯æŒå¤šç§é¥æ§å™¨

3. **æ—¥å¿—çº§åˆ«**
   - æ·»åŠ äº†è¾ƒå¤š LOGD è°ƒè¯•æ—¥å¿—
   - ç”Ÿäº§ç‰ˆæœ¬å¯èƒ½éœ€è¦è°ƒæ•´ä¸º ALOGV

---

### 9.2 å»ºè®®çš„åç»­å·¥ä½œ

1. **SELinux ç­–ç•¥**
   ```te
   # file_contexts
   /data/vendor/HBG(/.*)? u:object_r:hbg_data_file:s0

   # audioserver.te
   allow audioserver hbg_data_file:dir rw_dir_perms;
   allow audioserver hbg_data_file:file create_file_perms;
   ```

2. **å¤šé¥æ§å™¨æ”¯æŒ**
   - ä¿®æ”¹ HAL å±‚æ”¯æŒå¤šç»„ VID/PID
   - æˆ–ä½¿ç”¨è®¾å¤‡ç™½åå•

3. **é”™è¯¯å¤„ç†å¢å¼º**
   - æ·»åŠ æ›´è¯¦ç»†çš„é”™è¯¯ç 
   - æä¾›ç”¨æˆ·çº§é”™è¯¯æç¤º

4. **æ€§èƒ½ä¼˜åŒ–**
   - å‡å°‘ `access()` ç³»ç»Ÿè°ƒç”¨é¢‘ç‡
   - ä½¿ç”¨ inotify ç›‘å¬æ–‡ä»¶å˜åŒ–

---

## åã€æ€»ç»“

### 10.1 å®æ–½ç»Ÿè®¡

| ç±»åˆ« | æ•°é‡ |
|------|------|
| æ–°å¢æ–‡ä»¶ | 6 |
| ä¿®æ”¹æ–‡ä»¶ | 19 |
| ä»£ç è¡Œæ•°ï¼ˆæ–°å¢/ä¿®æ”¹ï¼‰ | ~200 è¡Œ |
| ä¿®æ”¹æ¨¡å— | ç³»ç»Ÿæ¡†æ¶ã€AudioPolicyManagerã€HAL å±‚ã€HIDL/AIDLã€é…ç½®æ–‡ä»¶ã€äº§å“é…ç½®ã€Android.bp |
| å·¥ä½œé‡ä¼°è®¡ | 2-3 äººæ—¥ |
| æµ‹è¯•çŠ¶æ€ | âœ… **æ‰€æœ‰åŠŸèƒ½å·²æµ‹è¯•é€šè¿‡** |

---

### 10.2 å…³é”®æˆåŠŸå› ç´ 

1. âœ… **å‡†ç¡®è¯†åˆ« Audio HAL ç‰ˆæœ¬**ï¼ˆ7.1 è€Œé 7.0ï¼‰
2. âœ… **é¥æ§å™¨ VID/PID æ­£ç¡®é…ç½®**ï¼ˆ0x000d/0x3838ï¼‰
3. âœ… **å¤ç”¨ç°æœ‰ç¼–è¯‘ç»“æ„**ï¼ˆvendor/giec/executableï¼‰
4. âœ… **ç®€åŒ–é›†æˆæ–¹æ¡ˆ**ï¼ˆç›´æ¥ä¿®æ”¹ init.rcï¼‰
5. âœ… **å®Œæ•´çš„ 7.0 å’Œ 7.1 æ”¯æŒ**
6. âœ… **æ‰¾åˆ°æ­£ç¡®çš„é…ç½®æºå¤´**ï¼ˆaudio_policy_common_base.xml è€Œé temp æ–‡ä»¶ï¼‰
7. âœ… **æ¨¡å—åŒ–é…ç½®ç®¡ç†**ï¼ˆåœ¨ vendor/giec/device-giec.mk ä¸­å£°æ˜æ¨¡å—ï¼‰

---

### 10.3 é£é™©è¯„ä¼°

| é£é™©é¡¹ | çº§åˆ« | ç¼“è§£æªæ–½ |
|--------|------|---------|
| è®¾å¤‡ç±»å‹å€¼å†²çª | ä½ | å·²éªŒè¯æ— å†²çªï¼ˆOUT vs INï¼‰ |
| SELinux æƒé™é—®é¢˜ | ä¸­ | å¼€å‘é˜¶æ®µä½¿ç”¨ setenforce 0 |
| å¤šé¥æ§å™¨å…¼å®¹æ€§ | ä¸­ | å½“å‰ä»…æ”¯æŒå•ä¸€å‹å· |
| Audio HAL ç‰ˆæœ¬å‡çº§ | ä½ | å·²åŒæ—¶æ”¯æŒ 7.0 å’Œ 7.1 |

---

### 10.4 ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. âœ… **ä»£ç å·²å®Œæˆ** - æ‰€æœ‰ 25 å¤„ä¿®æ”¹å·²å®Œæˆï¼ˆ6 ä¸ªæ–°å¢ + 19 ä¸ªä¿®æ”¹ï¼‰
2. âœ… **ç¼–è¯‘éªŒè¯** - å·²æˆåŠŸæ‰§è¡Œå…¨ç¼–è¯‘ï¼ˆè€—æ—¶ 12 åˆ† 51 ç§’ï¼‰
3. âœ… **åŠŸèƒ½æµ‹è¯•** - æ‰€æœ‰åŠŸèƒ½å·²æµ‹è¯•é€šè¿‡
4. âœ… **é—®é¢˜ä¿®å¤** - å·²è§£å†³æ‰€æœ‰ç¼–è¯‘å’Œè¿è¡Œæ—¶é—®é¢˜
5. â­ï¸ **ä»£ç å®¡æŸ¥** - æäº¤ git commit å¹¶å®¡æŸ¥
6. â­ï¸ **æ–‡æ¡£å½’æ¡£** - è®°å½•æµ‹è¯•ç»“æœå’Œé‡åˆ°çš„é—®é¢˜

---

## é™„å½• Aï¼šå¿«é€Ÿå‚è€ƒ

### A.1 å…³é”®æ–‡ä»¶è·¯å¾„

```
vendor/giec/executable/hbg/
â”œâ”€â”€ audio.blehid.default.so        # HAL å®ç°
â”œâ”€â”€ libhbgdecode.so                # è§£ç åº“
â”œâ”€â”€ remote.txt                     # é¥æ§å™¨é…ç½®
â””â”€â”€ Android.mk                     # ç¼–è¯‘é…ç½®

device/amlogic/common/audio/
â””â”€â”€ blehid_audio_policy_configuration.xml    # éŸ³é¢‘ç­–ç•¥

system/media/audio/include/system/
â”œâ”€â”€ audio-hal-enums.h              # è®¾å¤‡ç±»å‹å®šä¹‰
â””â”€â”€ audio-base-utils.h             # è®¾å¤‡é›†åˆ

frameworks/av/services/audiopolicy/managerdefault/
â””â”€â”€ AudioPolicyManager.cpp         # è®¾å¤‡åˆ‡æ¢é€»è¾‘

hardware/interfaces/audio/
â”œâ”€â”€ common/7.0/enums/include/android_audio_policy_configuration_V7_0-enums.h
â”œâ”€â”€ common/7.1/enums/include/android_audio_policy_configuration_V7_1-enums.h
â”œâ”€â”€ 7.0/config/audio_policy_configuration.xsd
â”œâ”€â”€ 7.1/config/audio_policy_configuration.xsd
â””â”€â”€ core/all-versions/default/StreamIn.cpp
```

---

### A.2 å…³é”®å¸¸é‡

```c
// è®¾å¤‡ç±»å‹
AUDIO_DEVICE_IN_BLEHID = 0x80200000

// éŸ³é¢‘å‚æ•°
SAMPLE_RATE = 16000
FORMAT = AUDIO_FORMAT_PCM_16_BIT (0x1)
CHANNEL_MASK = AUDIO_CHANNEL_IN_MONO (0x10)

// é¥æ§å™¨é…ç½®
VENDOR_ID = 0x000d
PRODUCT_ID = 0x3838

// è§¦å‘æ–‡ä»¶
TRIGGER_FILE = "/data/vendor/HBG/ble"
```

---

### A.3 å…³é”®æ—¥å¿—

```bash
# AudioPolicyManager
adb logcat | grep "APM_AudioPolicyManager"

# StreamIn HAL
adb logcat | grep "StreamInHAL"

# Audio Policy
adb shell dumpsys media.audio_policy

# Input Devices
adb shell dumpsys input
```

---

## é™„å½• Bï¼šGit Commit å»ºè®®

### B.1 Commit æ¶ˆæ¯æ¨¡æ¿

```
feat(audio): Add BLEHID device support for BLE remote voice input

Summary:
- Add AUDIO_DEVICE_IN_BLEHID device type (0x80200000)
- Implement automatic device switching in AudioPolicyManager
- Add HBG Audio HAL libraries and configurations
- Support both Audio HAL 7.0 and 7.1

Changes:
- System framework: audio-hal-enums.h, audio-base-utils.h
- AudioPolicyManager: device switching logic
- HAL layer: StreamIn HBG special handling
- HIDL/AIDL: V7.0 and V7.1 interface support
- Configurations: blehid audio policy, init.rc

Hardware:
- Vendor: 0x000d, Product: 0x3838
- Sample rate: 16kHz, Format: PCM_16_BIT, Channel: MONO

Testing:
- Verified with RecordTool.apk
- Checked audio policy module loading
- Validated device switching with /data/vendor/HBG/ble trigger

ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
```

---

### B.2 åˆ†é˜¶æ®µæäº¤å»ºè®®

```bash
# Commit 1: æ·»åŠ åº“æ–‡ä»¶å’Œé…ç½®
git add vendor/giec/executable/hbg/
git commit -m "feat(audio): Add HBG BLE remote HAL libraries and configs"

# Commit 2: ç³»ç»Ÿæ¡†æ¶ä¿®æ”¹
git add system/media/audio/include/system/
git commit -m "feat(audio): Define AUDIO_DEVICE_IN_BLEHID device type"

# Commit 3: AudioPolicyManager
git add frameworks/av/services/audiopolicy/managerdefault/AudioPolicyManager.cpp
git commit -m "feat(audio): Implement BLEHID device switching in AudioPolicyManager"

# Commit 4: HAL å±‚ä¿®æ”¹
git add hardware/interfaces/audio/
git commit -m "feat(audio): Add HIDL/AIDL support for BLEHID (V7.0 and V7.1)"

# Commit 5: é…ç½®æ–‡ä»¶
git add device/amlogic/common/
git commit -m "feat(audio): Configure BLEHID audio policy and init.rc"
```

---

## é™„å½• Cï¼šå®é™…æµ‹è¯•ç»“æœä¸é—®é¢˜åˆ†æ

### C.1 ç¼–è¯‘æµ‹è¯•

**ç¼–è¯‘å‘½ä»¤ï¼š**
```bash
source build/envsetup.sh && make installclean && ./build.sh -aj250
```

**ç¼–è¯‘ç»“æœï¼š**
- âœ… ç¼–è¯‘æˆåŠŸå®Œæˆ
- â±ï¸ æ€»è€—æ—¶ï¼š12 åˆ† 51 ç§’
- ğŸ”§ æ„å»ºç±»å‹ï¼šuserdebug
- âŒ FAILED é”™è¯¯æ•°ï¼š0
- âœ… æ‰€æœ‰ blehid ç›¸å…³æ–‡ä»¶æ­£ç¡®ç¼–è¯‘å’Œå®‰è£…

**ç”Ÿæˆçš„å…³é”®æ–‡ä»¶ï¼š**
```bash
out/target/product/ross/vendor/lib/hw/audio.blehid.default.so (22KB)
out/target/product/ross/vendor/lib/libhbgdecode.so (46KB)
out/target/product/ross/vendor/etc/blehid_audio_policy_configuration.xml (785 bytes)
out/target/product/ross/vendor/etc/audio_policy_configuration.xml (å·²åŒ…å« blehid å¼•ç”¨)
```

---

### C.2 è¿è¡Œæ—¶éªŒè¯

**éŸ³é¢‘æ¨¡å—åŠ è½½çŠ¶æ€ï¼š**
```bash
adb shell dumpsys media.audio_policy | grep -E "module name|Handle"

Hardware modules (5):
  1. Handle: 10; "primary"     âœ…
  2. Handle: 18; "usb"         âœ…
  3. Handle: 26; "r_submix"    âœ…
  4. Handle: 34; "bluetooth"   âœ…
  5. Handle: 42; "blehid"      âœ… æˆåŠŸæ³¨å†Œï¼
```

**blehid æ¨¡å—è¯¦ç»†ä¿¡æ¯ï¼š**
```bash
adb shell dumpsys media.audio_policy | grep -A 10 "blehid"

  5. Handle: 42; "blehid"
   - Input MixPorts (1):
      1. "blehid input"; 0x0000 (AUDIO_INPUT_FLAG_NONE)
       - Profiles (1):
          1. ""; AUDIO_FORMAT_PCM_16_BIT (0x1)
             sampling rates: 16000
             channel masks: 0x0010
       - Supported devices (1):
        1. Port ID: 19; "hbg_audio"; {AUDIO_DEVICE_IN_BLEHID, @:}
```

**å…³é”®å‘ç°ï¼š**
âœ… **blehid æ¨¡å—å·²æˆåŠŸé›†æˆåˆ°éŸ³é¢‘ç³»ç»Ÿ**
âœ… **Handle: 42 è¯æ˜æ¨¡å—å·²è¢« AudioPolicyService æ­£ç¡®æ³¨å†Œ**
âœ… **è®¾å¤‡ç±»å‹ AUDIO_DEVICE_IN_BLEHID (0x80200000) å·²è¢«è¯†åˆ«**

---

### C.3 /dev/hidraw* è®¾å¤‡èŠ‚ç‚¹é—®é¢˜åˆ†æ

**é—®é¢˜ç°è±¡ï¼š**
```bash
adb shell ls -l /dev/hidraw*
# è¾“å‡ºï¼šNo such file or directory
```

**åˆæ­¥åˆ†æï¼ˆåè¯æ˜ä¸å®Œå…¨å‡†ç¡®ï¼‰ï¼š**
1. âŒ çŒœæµ‹ï¼šå†…æ ¸æœªå¯ç”¨ CONFIG_BT_HIDP æ”¯æŒ
2. âŒ çŒœæµ‹ï¼šå¯¼è‡´ BLE HID è®¾å¤‡æ— æ³•è¢«è¯†åˆ«
3. âŒ çŒœæµ‹ï¼šå› æ­¤ /dev/hidraw* èŠ‚ç‚¹æ— æ³•åˆ›å»º
4. âŒ çŒœæµ‹ï¼šä»è€Œå½±å“ blehid HAL åŠŸèƒ½

**å®é™…æµ‹è¯•ç»“æœï¼š**
âœ… **å³ä½¿ /dev/hidraw* èŠ‚ç‚¹ä¸å­˜åœ¨ï¼ŒåŠŸèƒ½ä»ç„¶å®Œç¾æµ‹è¯•é€šè¿‡ï¼**

**ä¿®æ­£åçš„ç†è§£ï¼š**
1. âœ… blehid æ¨¡å—å·²æˆåŠŸåŠ è½½ï¼ˆHandle: 42ï¼‰
2. âœ… audio.blehid.default.so HAL å¯èƒ½ä½¿ç”¨å…¶ä»–æœºåˆ¶ä¸ BLE è®¾å¤‡é€šä¿¡
3. âœ… ä¾›åº”å•†çš„ HAL å®ç°å¯èƒ½ä¸ä¾èµ– hidraw è®¾å¤‡èŠ‚ç‚¹
4. âœ… å¯èƒ½é€šè¿‡ Bluetooth HIDP åè®®æ ˆçš„å…¶ä»–æ¥å£ç›´æ¥é€šä¿¡

**ç»“è®ºï¼š**
**/dev/hidraw* è®¾å¤‡èŠ‚ç‚¹çš„å­˜åœ¨ä¸å¦ä¸å½±å“å½“å‰åŠŸèƒ½å®ç°**ã€‚ä¾›åº”å•†æä¾›çš„ audio.blehid.default.so HAL åº“å¯èƒ½ï¼š
- ä½¿ç”¨ Android Bluetooth stack çš„é«˜å±‚ API
- é€šè¿‡ BluetoothHidDevice æˆ–ç±»ä¼¼æœåŠ¡ç›´æ¥é€šä¿¡
- æˆ–å®ç°äº†è‡ªå®šä¹‰çš„ BLE é€šä¿¡æœºåˆ¶

---

### C.4 åŠŸèƒ½æµ‹è¯•ç»“æœ

**æµ‹è¯•é¡¹ç›®ï¼š**
1. âœ… é¥æ§å™¨è“ç‰™é…å¯¹
2. âœ… è¯­éŸ³æŒ‰é”®è¯†åˆ«
3. âœ… éŸ³é¢‘è¾“å…¥è®¾å¤‡è‡ªåŠ¨åˆ‡æ¢ï¼ˆBuilt-in Mic â†’ BLEHIDï¼‰
4. âœ… 16kHz / PCM_16_BIT / MONO éŸ³é¢‘å½•åˆ¶
5. âœ… è§¦å‘æ–‡ä»¶ `/data/vendor/HBG/ble` åˆ›å»ºå’Œæ£€æµ‹
6. âœ… å½•éŸ³ APP åŠŸèƒ½æ­£å¸¸
7. âœ… AudioPolicyManager è®¾å¤‡åˆ‡æ¢é€»è¾‘ç”Ÿæ•ˆ

**æµ‹è¯•ç¯å¢ƒï¼š**
- äº§å“ï¼šross (Android 14, Amlogic S905X5)
- é¥æ§å™¨ï¼šVID=0x000d, PID=0x3838
- ç¼–è¯‘ç±»å‹ï¼šuserdebug
- SELinuxï¼šenforcingï¼ˆæœªä½¿ç”¨ setenforce 0ï¼‰

**æµ‹è¯•ç»“è®ºï¼š**
**ğŸ‰ æ‰€æœ‰åŠŸèƒ½å®Œç¾æµ‹è¯•é€šè¿‡ï¼Œç³»ç»Ÿè¿è¡Œç¨³å®šï¼**

---

### C.5 å…³é”®ç»éªŒæ•™è®­

1. **ä¸è¦è¿‡åº¦ä¾èµ–ç†è®ºåˆ†æ**
   - ä¹‹å‰è®¤ä¸ºç¼ºå°‘ /dev/hidraw* ä¼šå¯¼è‡´åŠŸèƒ½å¤±æ•ˆ
   - å®é™…æµ‹è¯•è¯æ˜åŠŸèƒ½å®Œå…¨æ­£å¸¸
   - **ç»“è®º**ï¼šä¾›åº”å•† HAL å®ç°å¯èƒ½ä½¿ç”¨ä¸åŒçš„é€šä¿¡æœºåˆ¶

2. **Android.bp æ¨¡å—å®šä¹‰çš„é‡è¦æ€§**
   - åˆå§‹åªå…³æ³¨ XML é…ç½®å’Œ HAL åº“
   - ç¼–è¯‘æ—¶å‘ç°éœ€è¦ Android.bp å®šä¹‰æ‰èƒ½æ­£ç¡®ç”Ÿæˆ criterion types
   - **ç»“è®º**ï¼šå¿…é¡»åŒæ—¶ä¿®æ”¹ Android.bp ä»¥ç¡®ä¿å®Œæ•´çš„æ¨¡å—é›†æˆ

3. **audio_policy_common_base.xml æ˜¯çœŸæ­£çš„æºå¤´**
   - ä¸è¦ä¿®æ”¹ audio_policy_configuration_temp.xmlï¼ˆä¼šè¢«è¦†ç›–ï¼‰
   - Amlogic å¹³å°ä½¿ç”¨ Python åŠ¨æ€ç”Ÿæˆé…ç½®
   - **ç»“è®º**ï¼šå¿…é¡»ä¿®æ”¹æºæ¨¡æ¿æ–‡ä»¶æ‰èƒ½ä¿è¯ä¿®æ”¹æŒä¹…åŒ–

4. **API é¡ºåºçš„ä¸¥æ ¼è¦æ±‚**
   - Metalava è¦æ±‚æšä¸¾å¸¸é‡æŒ‰ ASCII ç é¡ºåºæ’åˆ—
   - BLEHID å¿…é¡»æ’åœ¨ BLE_HEADSET å‰é¢ï¼ˆ'H' < '_'ï¼‰
   - **ç»“è®º**ï¼šä¿®æ”¹ API å®šä¹‰æ—¶å¿…é¡»æ³¨æ„å­—æ¯é¡ºåº

5. **éªŒè¯ dumpsys æ¯”æŸ¥çœ‹é…ç½®æ–‡ä»¶æ›´å¯é **
   - é…ç½®æ–‡ä»¶å¯èƒ½è¢«æ­£ç¡®éƒ¨ç½²ï¼Œä½†æ¨¡å—æœªåŠ è½½
   - dumpsys æ˜¾ç¤ºçš„æ˜¯å®é™…è¿è¡ŒçŠ¶æ€
   - **ç»“è®º**ï¼šä½¿ç”¨ `dumpsys media.audio_policy` éªŒè¯æ¨¡å—æ˜¯å¦çœŸæ­£æ³¨å†Œ

---

**æ–‡æ¡£ç»“æŸ**

---

**ç»´æŠ¤è¯´æ˜ï¼š**
- æœ¬æ–‡æ¡£åŸºäºå®é™…æ‰§è¡Œæ­¥éª¤ç¼–å†™
- æ‰€æœ‰ä¿®æ”¹ä½ç½®ã€è¡Œå·ã€ä»£ç ç‰‡æ®µå‡å·²éªŒè¯
- ä¸ patch çš„å·®å¼‚å·²è¯¦ç»†è¯´æ˜åŸå› 
- åŒ…å«å®Œæ•´çš„éªŒè¯æ­¥éª¤å’Œæ•…éšœæ’é™¤æŒ‡å—
- **v3.0 æ›´æ–°**ï¼šæ·»åŠ äº†å®Œæ•´çš„æµ‹è¯•ç»“æœå’Œé—®é¢˜åˆ†æ

å¦‚æœ‰ç–‘é—®ï¼Œè¯·å‚è€ƒï¼š
1. ä¾›åº”å•†åŸå§‹ patchï¼š`bt-remote-patch/android14/é™„åŠ æ–¹æ¡ˆ.patch`
2. ä¾›åº”å•†è¯´æ˜æ–‡æ¡£ï¼š`bt-remote-patch/å…³äºpatchçš„ç‰¹åˆ«è¯´æ˜.txt`
3. æœ¬æ–‡æ¡£å„ç« èŠ‚çš„è¯¦ç»†è¯´æ˜
4. **é™„å½• Cï¼šå®é™…æµ‹è¯•ç»“æœä¸é—®é¢˜åˆ†æ**
